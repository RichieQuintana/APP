name: CI - Python App

on:
  push:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:

    - name: Checkout c√≥digo
      uses: actions/checkout@v3

    - name: Login Docker Hub
      run: echo "${{ secrets.DOCKER_PASS }}" | docker login -u "${{ secrets.DOCKER_USER }}" --password-stdin

    - name: Build imagen Docker
      run: docker build -t richieq/app:${{ github.sha }} .

    - name: Push imagen Docker
      run: docker push richieq/app:${{ github.sha }}

    - name: Actualizar repo INFRA
      env:
        PAT: ${{ secrets.GH_PAT }}
      run: |
        echo "üîÑ Clonando repo infra..."
        git clone https://x-access-token:${PAT}@github.com/RichieQuintana/infra-proyecto-CI.git
        cd infra-proyecto-CI

        echo "‚úèÔ∏è Actualizando deployment..."
        sed -i "s|image: .*|image: richieq/app:${{ github.sha }}|" k8s/deployment.yaml

        git config user.email "actions@github.com"
        git config user.name "github-actions"

        git add k8s/deployment.yaml
        git commit -m "Actualizando deployment con imagen nueva" || echo "Sin cambios"

        echo "üöÄ Haciendo push..."
        git push https://x-access-token:${PAT}@github.com/RichieQuintana/infra-proyecto-CI.git
