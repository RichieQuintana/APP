name: CI - Python App

permissions:
  contents: write   # ğŸ’¥ Esto permite push al repo infra usando GITHUB_TOKEN

on:
  push:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:

    - name: Checkout cÃ³digo
      uses: actions/checkout@v3

    - name: Login Docker Hub
      run: echo "${{ secrets.DOCKER_PASS }}" | docker login -u "${{ secrets.DOCKER_USER }}" --password-stdin

    - name: Build imagen Docker
      run: docker build -t richiequintana/app:${{ github.sha }} .

    - name: Push imagen Docker
      run: docker push richiequintana/app:${{ github.sha }}

    - name: Actualizar repo INFRA
      env:
        TOKEN: ${{ secrets.GITHUB_TOKEN }}  # ğŸ’¥ Usamos solo GITHUB_TOKEN, sin tokens personales
      run: |
        echo "ğŸ”„ Clonando repositorio INFRA..."
        git clone https://github.com/RichieQuintana/infra-proyecto-CI.git
        cd infra-proyecto-CI

        echo "âœï¸ Actualizando versiÃ³n de la imagen en deployment.yaml..."
        sed -i "s|image: .*|image: richieq/app:${{ github.sha }}|" k8s/deployment.yaml

        echo "ğŸ“ Configurando git..."
        git config user.name "github-actions"
        git config user.email "actions@github.com"

        git add k8s/deployment.yaml
        git commit -m "Actualizando deployment con nueva imagen" || echo "Sin cambios"

        echo "ğŸ” Configurando remote con GITHUB_TOKEN..."
        git remote set-url origin https://x-access-token:${TOKEN}@github.com/RichieQuintana/infra-proyecto-CI.git

        echo "ğŸš€ Haciendo push a infra-proyecto-CI..."
        git push
