name: CI - Python App

on:
  push:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
    - name: Checkout c√≥digo
      uses: actions/checkout@v3

    - name: Login Docker Hub
      run: echo "${{ secrets.DOCKER_PASS }}" | docker login -u "${{ secrets.DOCKER_USER }}" --password-stdin

    - name: Build imagen Docker
      run: docker build -t richieq/app:${{ github.sha }} .

    - name: Push imagen
      run: docker push richieq/app:${{ github.sha }}

    - name: Actualizar repo INFRA
      env:
        TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        git clone https://github.com/RichieQuintana/infra-proyecto-CI.git
        cd infra-proyecto-CI
        sed -i "s|image: .*|image: richieq/app:${{ github.sha }}|" k8s/deployment.yaml
        git config user.name "github-actions"
        git config user.email "actions@github.com"
        git add k8s/deployment.yaml
        git commit -m "Actualizando deployment con nueva imagen" || echo "Sin cambios"
        git remote set-url origin https://x-access-token:${TOKEN}@github.com/RichieQuintana/infra-proyecto-CI.git
        git push
